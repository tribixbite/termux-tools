#!/data/data/com.termux/files/usr/bin/bash
# ~/.termux/boot/startup.sh
# Runs automatically when device boots (requires Termux:Boot app)
# Creates separate tmux instances for each project

# Acquire wake lock to prevent sleep during startup
termux-wake-lock

# Log boot startup
echo "[$(date)] Boot startup initiated" >> "$HOME/.termux/boot.log"

# Load repository configuration
source "$HOME/.termux/boot/repos.conf"

# Counter for tracking instances
instance_count=0

# Create separate tmux instance for each repo
for repo in "${!REPOS[@]}"; do
  # Parse config: auto_go:enabled
  IFS=':' read -r auto_go enabled <<< "${REPOS[$repo]}"

  # Skip if not enabled
  if [ "$enabled" != "1" ]; then
    echo "[$(date)] Skipping disabled repo: $repo" >> "$HOME/.termux/boot.log"
    continue
  fi

  # Verify repo exists
  if [ ! -d "$repo" ]; then
    echo "[$(date)] Skipping non-existent repo: $repo" >> "$HOME/.termux/boot.log"
    continue
  fi

  # Get repo name for session naming
  name=$(basename "$repo")

  # Create unique session name (lowercase, no special chars)
  session_name=$(echo "$name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')

  echo "[$(date)] Creating tmux instance: $session_name" >> "$HOME/.termux/boot.log"

  # Create new detached tmux session
  tmux new-session -d -s "$session_name" -c "$repo"

  # Start Claude Code in the session
  tmux send-keys -t "$session_name" "cc"
  tmux send-keys -t "$session_name" Enter

  # Auto-send 'go' if flagged
  if [ "$auto_go" = "1" ]; then
    sleep 1  # Wait for cc to fully start
    tmux send-keys -t "$session_name" "go"
    tmux send-keys -t "$session_name" Enter
    echo "[$(date)] Auto-sent 'go' to $session_name" >> "$HOME/.termux/boot.log"
  fi

  instance_count=$((instance_count + 1))
done

# Release wake lock after setup
termux-wake-unlock

echo "[$(date)] Boot startup completed - created $instance_count tmux instances" >> "$HOME/.termux/boot.log"

# Start cron daemon for scheduled tasks
if ! pgrep -x crond > /dev/null; then
  crond -s -P
  echo "[$(date)] Started crond" >> "$HOME/.termux/boot.log"
fi
