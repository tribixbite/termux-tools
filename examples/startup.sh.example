#!/data/data/com.termux/files/usr/bin/bash
# ~/.termux/boot/startup.sh
# Runs automatically when device boots (requires Termux:Boot app)
# Creates separate tmux instances for each project

# XDG-compliant paths
CONFIG_DIR="$HOME/.config/termux-boot"
LOG_DIR="$HOME/.local/share/termux-boot/logs"
BOOT_LOG="$LOG_DIR/boot.log"
BOT_LOG="$LOG_DIR/discord-bot.log"

# Ensure directories exist
mkdir -p "$CONFIG_DIR" "$LOG_DIR"

# Acquire wake lock to prevent sleep during startup
termux-wake-lock

# Log boot startup
echo "[$(date)] Boot startup initiated" >> "$BOOT_LOG"

# Load repository configuration
# Check both old and new locations
if [ -f "$CONFIG_DIR/repos.conf" ]; then
  source "$CONFIG_DIR/repos.conf"
elif [ -f "$HOME/.termux/boot/repos.conf" ]; then
  source "$HOME/.termux/boot/repos.conf"
else
  echo "[$(date)] ERROR: repos.conf not found" >> "$BOOT_LOG"
  termux-notification --title "Boot Error" --content "repos.conf not found"
  termux-wake-unlock
  exit 1
fi

# Counter for tracking instances
instance_count=0
error_count=0

# Create separate tmux instance for each repo
for repo in "${!REPOS[@]}"; do
  # Parse config: auto_go:enabled
  IFS=':' read -r auto_go enabled <<< "${REPOS[$repo]}"

  # Skip if not enabled
  if [ "$enabled" != "1" ]; then
    echo "[$(date)] Skipping disabled repo: $repo" >> "$BOOT_LOG"
    continue
  fi

  # Verify repo exists
  if [ ! -d "$repo" ]; then
    echo "[$(date)] ERROR: Skipping non-existent repo: $repo" >> "$BOOT_LOG"
    error_count=$((error_count + 1))
    continue
  fi

  # Get repo name for session naming
  name=$(basename "$repo")

  # Create unique session name (lowercase, no special chars)
  session_name=$(echo "$name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')

  echo "[$(date)] Creating tmux instance: $session_name" >> "$BOOT_LOG"

  # Create new detached tmux session
  if ! tmux new-session -d -s "$session_name" -c "$repo" 2>> "$BOOT_LOG"; then
    echo "[$(date)] ERROR: Failed to create session: $session_name" >> "$BOOT_LOG"
    error_count=$((error_count + 1))
    continue
  fi

  # Start Claude Code in the session
  tmux send-keys -t "$session_name" "cc"
  tmux send-keys -t "$session_name" Enter

  # Auto-send 'go' if flagged
  if [ "$auto_go" = "1" ]; then
    sleep 1  # Wait for cc to fully start
    tmux send-keys -t "$session_name" "go"
    tmux send-keys -t "$session_name" Enter
    echo "[$(date)] Auto-sent 'go' to $session_name" >> "$BOOT_LOG"
  fi

  instance_count=$((instance_count + 1))
done

# Start discord-irc bot in separate session with logging
if [ -d "$HOME/git/dirc" ] && [ -f "$HOME/git/discord-irc/dist/lib/cli.js" ]; then
  echo "[$(date)] Creating tmux instance: discord-bot" >> "$BOOT_LOG"

  # Create tmux session for bot
  if tmux new-session -d -s discord-bot -c "$HOME/git/dirc" 2>> "$BOOT_LOG"; then
    # Start the bot with output redirected to log file
    # Use script to capture output with timestamps
    tmux send-keys -t discord-bot "NODE_ENV=development bun ../discord-irc/dist/lib/cli.js 2>&1 | tee -a '$BOT_LOG'"
    tmux send-keys -t discord-bot Enter

    echo "[$(date)] Started discord-irc bot (logging to $BOT_LOG)" >> "$BOOT_LOG"
    instance_count=$((instance_count + 1))
  else
    echo "[$(date)] ERROR: Failed to create discord-bot session" >> "$BOOT_LOG"
    error_count=$((error_count + 1))
  fi
fi

# Release wake lock after setup
termux-wake-unlock

# Final status
echo "[$(date)] Boot startup completed - created $instance_count tmux instances ($error_count errors)" >> "$BOOT_LOG"

# Send notification with status
if [ $error_count -eq 0 ]; then
  termux-notification --title "Termux Boot" --content "✓ Started $instance_count sessions"
else
  termux-notification --title "Termux Boot" --content "⚠ Started $instance_count sessions ($error_count errors)"
fi

# Start cron daemon for scheduled tasks
if ! pgrep -x crond > /dev/null; then
  crond -s -P
  echo "[$(date)] Started crond" >> "$BOOT_LOG"
fi
