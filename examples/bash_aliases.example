#!/data/data/com.termux/files/usr/bin/bash
# ~/.bash_aliases
# Tmux instance management for boot automation

# Smart session switcher - attach to separate tmux instances
# Usage: tm clev (matches cleverkeys), tm un (matches Unexpected-Keyboard)
# If session doesn't exist but repo found in ~/git/, creates new instance
tm() {
  local search="$1"

  if [ -z "$search" ]; then
    echo "Usage: tm <search>"
    echo "Example: tm clev (matches cleverkeys)"
    echo "         tm un   (matches Unexpected-Keyboard)"
    return 1
  fi

  # Convert search to lowercase for matching
  search=$(echo "$search" | tr '[:upper:]' '[:lower:]')

  # Get list of tmux sessions
  local sessions=$(tmux list-sessions -F "#{session_name}" 2>/dev/null)

  if [ -z "$sessions" ]; then
    echo "No tmux sessions found. Run boot startup or create manually."
    return 1
  fi

  # Search for matching session (case-insensitive)
  local matched_session=""

  while read -r session; do
    # Convert session name to lowercase for comparison
    local session_lower=$(echo "$session" | tr '[:upper:]' '[:lower:]')
    if [[ "$session_lower" == *"$search"* ]]; then
      matched_session="$session"
      echo "Found session: $session"
      break
    fi
  done <<< "$sessions"

  # If session found, attach to it
  if [ -n "$matched_session" ]; then
    tmux attach -t "$matched_session"
    return 0
  fi

  # Session not found, search ~/git/ for matching repo
  echo "Session not found, searching ~/git/ for repos..."
  local matched_repo=""

  if [ -d "$HOME/git" ]; then
    for dir in "$HOME/git"/*/ "$HOME/git"/*/*/; do
      if [ -d "$dir" ]; then
        local dirname=$(basename "$dir")
        local dirname_lower=$(echo "$dirname" | tr '[:upper:]' '[:lower:]')

        if [[ "$dirname_lower" == *"$search"* ]]; then
          matched_repo="$dir"
          echo "Found repo: $dirname at $dir"
          break
        fi
      fi
    done
  fi

  # If repo found, create new instance
  if [ -n "$matched_repo" ]; then
    local repo_name=$(basename "$matched_repo")
    local session_name=$(echo "$repo_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')

    echo "Creating new tmux instance for $repo_name..."

    # Create new session
    tmux new-session -d -s "$session_name" -c "$matched_repo"
    tmux send-keys -t "$session_name" "cc"
    tmux send-keys -t "$session_name" Enter

    echo "✓ Created instance: $session_name"
    echo "  Use: tm $search to attach"

    # Attach to new session
    tmux attach -t "$session_name"
    return 0
  fi

  echo "Error: No session or repo found matching '$search'"
  echo ""
  echo "Available sessions:"
  tmux list-sessions -F "  #{session_name}"
  return 1
}

# Send 'go' command to a tmux session (by search term)
# Usage: tmgo clev (sends to cleverkeys session)
tmgo() {
  local search="$1"

  if [ -z "$search" ]; then
    echo "Usage: tmgo <search>"
    echo "Example: tmgo clev  (sends 'go' to cleverkeys)"
    echo "         tmgo un    (sends 'go' to Unexpected-Keyboard)"
    return 1
  fi

  # Convert search to lowercase for matching
  search=$(echo "$search" | tr '[:upper:]' '[:lower:]')

  # Get list of tmux sessions
  local sessions=$(tmux list-sessions -F "#{session_name}" 2>/dev/null)

  if [ -z "$sessions" ]; then
    echo "Error: No tmux sessions found"
    return 1
  fi

  # Search for matching session (case-insensitive)
  local matched_session=""

  while read -r session; do
    local session_lower=$(echo "$session" | tr '[:upper:]' '[:lower:]')
    if [[ "$session_lower" == *"$search"* ]]; then
      matched_session="$session"
      echo "Found session: $session"
      break
    fi
  done <<< "$sessions"

  if [ -z "$matched_session" ]; then
    echo "Error: No session found matching '$search'"
    echo ""
    echo "Available sessions:"
    tmux list-sessions -F "  #{session_name}"
    return 1
  fi

  # Send 'go' to the target session
  # Send text first, then Enter key separately to ensure proper execution
  tmux send-keys -t "$matched_session" "go" Enter
  tmux send-keys -t "$matched_session" C-m
  echo "✓ Sent 'go' to session: $matched_session"
}

# Core tmux session management aliases
alias tmbs='tmux list-sessions'              # List all tmux sessions
alias tmbka='tmux kill-server'               # Kill all tmux sessions
alias tmbls='tmux list-sessions -F "#{session_name}: #{session_windows} windows"'  # Detailed session list

# Function to create new tmux instance for a repo
# Usage: tmba foldername [auto_go]
# Example: tmba my-project    (no auto-go)
#          tmba my-project 1  (with auto-go)
tmba() {
  local folder="$1"
  local auto_go="${2:-0}"

  if [ -z "$folder" ]; then
    echo "Usage: tmba <foldername> [auto_go]"
    echo "Example: tmba my-project     (no auto-go)"
    echo "         tmba my-project 1   (with auto-go)"
    return 1
  fi

  # Determine full path
  local repo_path
  if [[ "$folder" == /* ]]; then
    repo_path="$folder"
  elif [[ "$folder" == */* ]]; then
    repo_path="$HOME/git/$folder"
  else
    repo_path="$HOME/git/$folder"
  fi

  if [ ! -d "$repo_path" ]; then
    echo "Error: Directory not found: $repo_path"
    return 1
  fi

  local name=$(basename "$repo_path")
  local session_name=$(echo "$name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')

  # Check if session already exists
  if tmux has-session -t "$session_name" 2>/dev/null; then
    echo "⚠ Session already exists: $session_name"
    echo "Attach with: tm $name"
    return 1
  fi

  echo "Creating tmux instance for $name..."

  # Create new session
  tmux new-session -d -s "$session_name" -c "$repo_path"
  tmux send-keys -t "$session_name" "cc"
  tmux send-keys -t "$session_name" Enter

  # Auto-send 'go' if flagged
  if [ "$auto_go" = "1" ]; then
    sleep 1
    tmux send-keys -t "$session_name" "go"
    tmux send-keys -t "$session_name" Enter
    echo "✓ Created instance: $session_name (with auto-go)"
  else
    echo "✓ Created instance: $session_name"
  fi

  echo "  Use: tm $name to attach"
  echo ""
  echo "To make this permanent: tmbp $folder $auto_go"
}

# Function to add repo permanently to repos.conf
# Usage: tmbp foldername [auto_go]
tmbp() {
  local folder="$1"
  local auto_go="${2:-0}"

  if [ -z "$folder" ]; then
    echo "Usage: tmbp <foldername> [auto_go]"
    echo "Permanently adds repo to ~/.termux/boot/repos.conf"
    echo "Example: tmbp my-project     (no auto-go)"
    echo "         tmbp my-project 1   (with auto-go)"
    return 1
  fi

  # Determine full path
  local repo_path
  if [[ "$folder" == /* ]]; then
    repo_path="$folder"
  elif [[ "$folder" == */* ]]; then
    repo_path="\$HOME/git/$folder"
  else
    repo_path="\$HOME/git/$folder"
  fi

  local repos_conf="$HOME/.termux/boot/repos.conf"

  # Check if already in repos.conf
  if grep -q "$repo_path" "$repos_conf"; then
    echo "⚠ Repo already exists in repos.conf: $repo_path"
    return 1
  fi

  # Add to repos.conf
  echo "REPOS[\"$repo_path\"]=\"$auto_go:1\"" >> "$repos_conf"

  echo "✓ Added to repos.conf: $repo_path"
  echo "  auto_go: $auto_go, enabled: 1"
  echo ""
  echo "To apply immediately: tmba $folder $auto_go"
  echo "To see changes: cat $repos_conf"
}

# Restart all boot instances (kill all and recreate)
tmbr() {
  echo "Restarting all tmux instances..."
  tmux kill-server 2>/dev/null
  ~/.termux/boot/startup.sh
  echo "✓ All instances restarted"
  echo "List sessions: tmbs"
  echo "Attach to any: tm <name>"
}

# Show tmux instances info
tmbi() {
  echo "=== Tmux Instances Info ==="
  local sessions=$(tmux list-sessions -F "#{session_name}" 2>/dev/null)

  if [ -z "$sessions" ]; then
    echo "Status: ✗ No sessions running"
    echo ""
    echo "Start with: ~/.termux/boot/startup.sh"
    echo "Or restart: tmbr"
    return 0
  fi

  echo "Status: ✓ Running"
  echo ""
  echo "Active sessions:"
  tmux list-sessions -F "  #{session_name}: #{session_windows} windows (#{session_attached} attached)"
  echo ""
  echo "Commands:"
  echo "  tm <name>     - Attach to session (fuzzy search)"
  echo "  tmgo <name>   - Send 'go' to session"
  echo "  tmbs          - List all sessions"
  echo "  tmbka         - Kill all sessions"
  echo "  tmba NAME [1] - Create new instance (1=auto-go)"
  echo "  tmbp NAME [1] - Add to repos.conf permanently"
  echo "  tmbr          - Restart all instances"
}

# Quick create/restart all instances
tmbb() {
  if tmux list-sessions 2>/dev/null | grep -q .; then
    echo "Tmux instances already running"
    tmbi
  else
    echo "No instances found. Creating..."
    ~/.termux/boot/startup.sh
    echo "✓ Created. List with: tmbs"
  fi
}

# Tmux general shortcuts (work in any session)
alias td='tmux detach'                   # Detach from current session
alias tz='tmux resize-pane -Z'           # Zoom/unzoom current pane
alias tw='tmux choose-tree -Zw'          # Interactive session/window list

# Window management (within current session)
alias tk='tmux kill-window'              # Kill current window
alias tnw='tmux new-window'              # New window in current session
alias trn='tmux rename-window'           # Rename window (usage: trn newname)

# Pane management
alias tsv='tmux split-window -v'         # Split vertically (top/bottom)
alias tsh='tmux split-window -h'         # Split horizontally (left/right)
alias tkp='tmux kill-pane'               # Kill current pane

# Pane navigation
alias t1='tmux select-pane -t 0'         # Go to pane 0
alias t2='tmux select-pane -t 1'         # Go to pane 1
alias t3='tmux select-pane -t 2'         # Go to pane 2
alias t4='tmux select-pane -t 3'         # Go to pane 3

# Pane movement (arrow-key equivalents)
alias tu='tmux select-pane -U'           # Up
alias tdown='tmux select-pane -D'        # Down
alias tleft='tmux select-pane -L'        # Left
alias tright='tmux select-pane -R'       # Right

# Session management
alias tls='tmux list-sessions'           # List all sessions
alias tas='tmux attach-session -t'       # Attach to session (usage: tas sessionname)
alias tks='tmux kill-session -t'         # Kill session (usage: tks sessionname)

# Quick send keys to current session (useful for automation)
tsend() {
  if [ -z "$1" ]; then
    echo "Usage: tsend <text>"
    echo "Sends text to current tmux session"
    return 1
  fi
  tmux send-keys "$*"
  tmux send-keys Enter
}

# Send to specific session
tsends() {
  local session="$1"
  shift
  if [ -z "$session" ] || [ -z "$1" ]; then
    echo "Usage: tsends <session-name> <text>"
    echo "Example: tsends cleverkeys 'go'"
    return 1
  fi
  tmux send-keys -t "$session" "$*"
  tmux send-keys -t "$session" Enter
}

# ADB wireless connection alias
alias adbc='~/git/termux-tools/tools/adb-wireless-connect.sh'

# Export functions for subshells
export -f tm tmgo tmba tmbp tmbr tmbi tmbb tsend tsends
